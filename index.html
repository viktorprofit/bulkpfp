<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bulk PFP Customizer</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,500;9..144,600;9..144,700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bulk-base:#141310;
      --bg-primary:#1B1A14;
      --text-primary:#FFFBEF;
      --text-secondary:#C6B6BA;
      --line:rgba(255,255,255,.08);
      --display-font:"Fraunces",serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text-primary);
      background:url("items/bd.png") center center / cover no-repeat fixed;
      font-family:var(--display-font);
      -webkit-font-smoothing:antialiased;
    }
    header.topbar{
      position:sticky;top:0;z-index:100;
      background:#11100Dcc;border-bottom:1px solid rgba(255,255,255,.06);
      backdrop-filter:blur(6px);
    }
    .topbar-inner{
      max-width:1200px;margin:0 auto;padding:10px 20px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .brand img{height:38px}
    .nav-pills{display:flex;gap:24px;padding:8px 16px;border-radius:999px;background:#151410;border:1px solid rgba(255,255,255,.08)}
    .nav-pills a{text-decoration:none;color:#FFFBEF;font-weight:600;font-size:14px;opacity:.9;transition:.25s}
    .nav-pills a:hover{opacity:1}
    .btn{
      appearance:none;width:auto;display:inline-flex;align-items:center;justify-content:center;
      gap:8px;color:#FFFBEF;border:1px solid var(--line);border-radius:12px;
      padding:14px 16px;cursor:pointer;font-family:var(--display-font);font-weight:700;
      background:radial-gradient(circle at 50% 120%,rgba(255,255,255,0.15) 0%,rgba(24,23,18,0.9) 80%);
      transition:.25s;box-shadow:inset 0 0 0 1px rgba(255,255,255,.03),0 1px 1px rgba(0,0,0,.35);
    }
    .btn:hover{background:radial-gradient(circle at 50% 110%,rgba(30,29,24,0.25) 0%,rgba(24,23,18,0.95) 75%)}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px;display:grid;gap:20px}
    .stage{
      position:relative;background:#0f0f0e;border:1px solid var(--line);border-radius:16px;padding:16px;
      display:flex;align-items:center;justify-content:center;
    }
    canvas{width:86%;background:#0f0f0e;border:1px dashed rgba(255,255,255,.08);border-radius:12px;cursor:grab}
    .panel{background:rgba(27,26,20,.96);border:1px solid var(--line);border-radius:16px;padding:14px}
    .panel .btn,.bar .btn{width:100%}
    .title{font-weight:700;font-size:22px;background:linear-gradient(180deg,#fffbed,#bfb7ab);
      -webkit-background-clip:text;color:transparent;}
    .thumbs{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .thumb{background:#1f1e1a;border:1px solid var(--line);border-radius:12px;min-height:78px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .thumb.active{border-color:#fffbe6;box-shadow:0 0 0 2px rgba(255,255,255,.25) inset,0 0 22px rgba(255,255,255,.15)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    label{color:var(--text-secondary);font-size:12px}
    input[type="range"]{width:100%;accent-color:#FFFBEF}
    .bar{display:flex;gap:10px;justify-content:space-between;margin-top:14px}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <a class="brand" href="#"><img src="items/bulk-logo.png" alt="Bulk logo"/></a>
      <nav class="nav-pills">
        <a href="https://alphadocs.bulk.trade/" target="_blank">Docs</a>
        <a href="https://t.me/tradebulk" target="_blank">Community</a>
        <a href="https://www.bulk.trade/articles" target="_blank">Articles</a>
      </nav>
      <a class="btn" href="https://discord.gg/bulk" target="_blank">Join Discord</a>
    </div>
  </header>

  <main class="wrap">
    <section class="stage"><canvas id="c" width="900" height="900"></canvas></section>

    <section>
      <div class="panel">
        <div class="title">Upload PFP</div>
        <p style="color:#C6B6BA;font-size:12px;margin:8px 0 12px;">PNG / JPG / WEBP â€” processed locally in your browser.</p>
        <input id="photo" type="file" accept="image/png,image/jpeg,image/webp" style="display:none"/>
        <button id="pickPhoto" class="btn">â¬† Select Image</button>
      </div>

      <div class="panel">
        <div class="title">Select Item</div>
        <div class="thumbs" id="thumbs">
          <button class="thumb" data-mask="cap1"><img src="items/cap-a.png"></button>
          <button class="thumb" data-mask="cap2"><img src="items/cap-b.png"></button>
          <button class="thumb" data-mask="bucket"><img src="items/bucket-hat.png"></button>
        </div>

        <div class="row">
          <div><label>Scale</label><input id="scale" type="range" min="0.2" max="3" value="1" step="0.01"></div>
          <div><label>Rotate (Â°)</label><input id="rotate" type="range" min="-180" max="180" value="0" step="1"></div>
        </div>
        <div class="row">
          <div><label>Opacity</label><input id="opacity" type="range" min="0" max="1" value="1" step="0.01"></div>
          <div><label>Export Size</label>
            <select id="exportSize">
              <option value="orig">Original</option>
              <option value="512">512Ã—512</option>
              <option value="1024">1024Ã—1024</option>
            </select>
          </div>
        </div>

        <div class="bar">
          <button id="download" class="btn">â¬‡ Download PNG</button>
          <button id="reset" class="btn">â†» Reset</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    const c=document.getElementById('c'),ctx=c.getContext('2d');
    const photo=document.getElementById('photo'),pick=document.getElementById('pickPhoto'),
          thumbs=document.getElementById('thumbs'),scale=document.getElementById('scale'),
          rotate=document.getElementById('rotate'),opacity=document.getElementById('opacity'),
          sizeSel=document.getElementById('exportSize'),reset=document.getElementById('reset'),
          dl=document.getElementById('download');

    const state={bgImg:null,capImg:null,cap:{x:0,y:0,w:0,h:0,scale:1,rot:0,alpha:1}};
    const items={cap1:'items/cap-a.png',cap2:'items/cap-b.png',bucket:'items/bucket-hat.png'};
    const loaded={}; for(const [k,v] of Object.entries(items)){const i=new Image();i.src=v;loaded[k]=i;}

    function render(){
      ctx.clearRect(0,0,c.width,c.height);
      if(state.bgImg) ctx.drawImage(state.bgImg,0,0,c.width,c.height);
      else{ctx.fillStyle='#0f0f0e';ctx.fillRect(0,0,c.width,c.height);}
      if(state.capImg){
        const{x,y,w,h,scale,rot,alpha}=state.cap, cw=w*scale,ch=h*scale,cx=x+cw/2,cy=y+ch/2;
        ctx.save();ctx.translate(cx,cy);ctx.rotate(rot*Math.PI/180);ctx.globalAlpha=alpha;
        ctx.drawImage(state.capImg,-cw/2,-ch/2,cw,ch);ctx.restore();ctx.globalAlpha=1;
      }
    }

    function fitCanvas(img){const MAX=1400;const w=img.naturalWidth,h=img.naturalHeight;const k=Math.min(1,MAX/Math.max(w,h));c.width=w*k;c.height=h*k;}
    function centerCap(img){const iw=img.naturalWidth,ih=img.naturalHeight;state.cap.w=iw;state.cap.h=ih;state.cap.scale=Math.min(1,(c.width/iw)*0.5);state.cap.x=c.width/2-(iw*state.cap.scale)/2;state.cap.y=c.height*0.2;scale.value=state.cap.scale;}

    pick.onclick=()=>photo.click();
    photo.onchange=async()=>{const f=photo.files?.[0];if(!f)return;const r=new FileReader();r.onload=()=>{const i=new Image();i.onload=()=>{state.bgImg=i;fitCanvas(i);render();};i.src=r.result;};r.readAsDataURL(f);};

    thumbs.onclick=e=>{const b=e.target.closest('.thumb');if(!b)return;state.capImg=loaded[b.dataset.mask];centerCap(state.capImg);document.querySelectorAll('.thumb').forEach(t=>t.classList.remove('active'));b.classList.add('active');render();};

    scale.oninput=()=>{state.cap.scale=parseFloat(scale.value);render();};
    rotate.oninput=()=>{state.cap.rot=parseFloat(rotate.value);render();};
    opacity.oninput=()=>{state.cap.alpha=parseFloat(opacity.value);render();};

    // ðŸŸ¢ Reset: Ñ‚Ñ–Ð»ÑŒÐºÐ¸ ÐºÐµÐ¿ÐºÐ°
    reset.onclick=()=>{
      state.capImg=null;
      state.cap={x:0,y:0,w:0,h:0,scale:1,rot:0,alpha:1};
      scale.value="1";rotate.value="0";opacity.value="1";
      document.querySelectorAll('.thumb').forEach(t=>t.classList.remove('active'));
      render();
    };

    // ðŸŸ¢ Drag ÐºÐµÐ¿ÐºÐ¸
    let drag=false,off={x:0,y:0};
    const point=e=>{const r=c.getBoundingClientRect();const x=(e.touches?.[0]?.clientX??e.clientX)-r.left;const y=(e.touches?.[0]?.clientY??e.clientY)-r.top;return{x:x*(c.width/r.width),y:y*(c.height/r.height)};}
    const hit=(mx,my)=>{if(!state.capImg)return false;const{x,y,w,h,scale,rot}=state.cap;const cw=w*scale,ch=h*scale,cx=x+cw/2,cy=y+ch/2;const dx=mx-cx,dy=my-cy,ang=-rot*Math.PI/180;const rx=dx*Math.cos(ang)-dy*Math.sin(ang);const ry=dx*Math.sin(ang)+dy*Math.cos(ang);return(rx>=-cw/2&&rx<=cw/2&&ry>=-ch/2&&ry<=ch/2);}
    function down(e){if(!state.capImg)return;const p=point(e);if(hit(p.x,p.y)){drag=true;off.x=p.x-state.cap.x;off.y=p.y-state.cap.y;c.style.cursor='grabbing';e.preventDefault();}}
    function move(e){if(!drag){const p=point(e);c.style.cursor=hit(p.x,p.y)?'grab':'default';return;}const p=point(e);state.cap.x=p.x-off.x;state.cap.y=p.y-off.y;render();}
    function up(){drag=false;c.style.cursor='default';}
    c.addEventListener('mousedown',down);window.addEventListener('mousemove',move);window.addEventListener('mouseup',up);
    c.addEventListener('touchstart',down,{passive:false});window.addEventListener('touchmove',move,{passive:false});window.addEventListener('touchend',up);

    // ðŸŸ¢ Download + Ð¿ÐµÑ€ÐµÑ…Ñ–Ð´
    function exportAndOpen(size){
      const o=document.createElement('canvas');const g=o.getContext('2d');
      if(size==='orig'){o.width=c.width;o.height=c.height;}else{const s=parseInt(size);o.width=s;o.height=s;}
      if(state.bgImg)g.drawImage(state.bgImg,0,0,o.width,o.height);else{g.fillStyle='#0f0f0e';g.fillRect(0,0,o.width,o.height);}
      if(state.capImg){const k=Math.min(o.width/c.width,o.height/c.height);const{x,y,w,h,scale,rot,alpha}=state.cap;const cw=w*scale*k,ch=h*scale*k,cx=(x*k)+cw/2,cy=(y*k)+ch/2;g.save();g.translate(cx,cy);g.rotate(rot*Math.PI/180);g.globalAlpha=alpha;g.drawImage(state.capImg,-cw/2,-ch/2,cw,ch);g.restore();}
      const data=o.toDataURL('image/png');const a=document.createElement('a');a.download='pfp.png';a.href=data;a.click();try{sessionStorage.setItem('bulk_pfp',data);}catch(e){console.warn(e);}setTimeout(()=>{window.location.href='ready.html';},200);
    }
    dl.onclick=()=>{exportAndOpen(sizeSel.value);}
  </script>
</body>
</html>
