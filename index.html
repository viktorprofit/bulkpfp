<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bulk PFP Customizer</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,500;9..144,600;9..144,700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bulk-base:#141310;
      --bg-primary:#1B1A14;
      --bg-secondary:#544A4C;
      --text-primary:#FFFBEF;
      --text-secondary:#C6B6BA;
      --line:rgba(255,255,255,.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text-primary);
      background:url('items/bd.png') center center / cover no-repeat fixed;
      font-family:"Fraunces",serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* ===== TOP BAR ===== */
    header.topbar{
      position:sticky; top:0; z-index:10;
      background:#11100Dcc;
      border-bottom:1px solid rgba(255,255,255,.06);
      backdrop-filter:blur(6px);
    }
    .topbar-inner{
      max-width:1200px; margin:0 auto; padding:10px 20px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none}
    .brand img{height:38px; display:block}
    .nav-pills{
      display:flex; align-items:center; gap:24px;
      padding:8px 16px; border-radius:999px;
      background:#151410; border:1px solid rgba(255,255,255,.08);
      box-shadow:inset 0 0 0 1px rgba(0,0,0,.25), 0 1px 0 rgba(255,255,255,.02);
    }
    .nav-pills a{
      text-decoration:none; color:#FFFBEF;
      font-weight:600; font-size:14px; letter-spacing:.01em;
      opacity:.92; padding:8px 6px; border-radius:8px;
      transition:opacity .2s ease, background .25s ease;
    }
    .nav-pills a:hover{opacity:1; background:rgba(255,255,255,.03)}
    .btn{
      appearance:none;width:auto;
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      color:#FFFBEF;border:1px solid var(--line);
      border-radius:12px;padding:12px 16px;cursor:pointer;
      font-family:inherit;font-weight:700;letter-spacing:.02em;
      background:radial-gradient(circle at 50% 120%,rgba(255,255,255,0.15) 0%,rgba(24,23,18,0.9) 80%);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.03), 0 1px 1px rgba(0,0,0,.35);
      transition:transform .08s ease, box-shadow .25s ease, background .25s ease;
    }
    .btn:hover{
      background:radial-gradient(circle at 50% 110%,rgba(30,29,24,0.25) 0%,rgba(24,23,18,0.95) 75%);
      box-shadow:0 2px 8px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.05);
    }
    .btn:active{transform:translateY(1px)}

    /* ===== LAYOUT ===== */
    .wrap{
      max-width:1100px;
      margin:28px auto;
      padding:0 16px;
      display:grid;
      gap:20px;
      grid-template-columns:1fr;
    }
    @media(min-width:1100px){.wrap{grid-template-columns:1.2fr .9fr}}

    .stage{
      position:relative;
      background:#0f0f0e;
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      box-shadow:0 30px 80px rgba(0,0,0,.55);
      display:flex;align-items:center;justify-content:center;
    }
    canvas{
      width:86%;
      background:#0f0f0e;
      border:1px dashed rgba(255,255,255,.08);
      border-radius:12px;
      display:block;
      cursor:grab;
      touch-action:none;
    }

    .panel{
      background:rgba(27,26,20,.96);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow:0 8px 22px rgba(0,0,0,.35);
    }
    .title{
      font-weight:700;font-size:22px;
      background:linear-gradient(180deg,#fffbed,#bfb7ab);
      -webkit-background-clip:text;background-clip:text;color:transparent;
    }
    .muted{color:var(--text-secondary);font-size:12px;font-family:sans-serif}
    .thumbs{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .thumb{background:#1f1e1a;border:1px solid var(--line);border-radius:12px;min-height:78px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
    .thumb img{max-width:88%;object-fit:contain}
    .thumb.active{border-color:#FFFBEF;box-shadow:0 0 12px rgba(255,255,255,.3)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    label{display:block;margin:6px 0;color:var(--text-secondary);font-size:12px}
    input[type="range"]{width:100%;accent-color:#FFFBEF}
    select{width:100%;padding:10px 12px;border-radius:10px;background:#201f1b;color:var(--text-primary);border:1px solid var(--line);}
    .bar{display:flex;justify-content:space-between;gap:10px;margin-top:14px}
  </style>
</head>
<body>
  <!-- TOP BAR -->
  <header class="topbar">
    <div class="topbar-inner">
      <a class="brand" href="#"><img src="items/bulk-logo.png" alt="Bulk logo"/></a>
      <nav class="nav-pills">
        <a href="https://alphadocs.bulk.trade/" target="_blank">Docs</a>
        <a href="https://t.me/tradebulk" target="_blank">Community</a>
        <a href="https://www.bulk.trade/articles" target="_blank">Articles</a>
      </nav>
      <a class="btn" href="https://discord.gg/bulk" target="_blank">Join Discord</a>
    </div>
  </header>

  <main class="wrap">
    <section class="stage" aria-label="Preview Stage">
      <canvas id="c" width="900" height="900"></canvas>
    </section>

    <section>
      <div class="panel">
        <div class="title">Upload PFP</div>
        <p class="muted">PNG / JPG / WEBP — processed locally in your browser.</p>
        <input id="photo" type="file" accept="image/png,image/jpeg,image/webp" style="display:none"/>
        <button id="pickPhoto" class="btn">⬆ Select Image</button>
      </div>

      <div class="panel">
        <div class="title">Select Item</div>
        <div class="thumbs" id="thumbs">
          <button class="thumb" data-mask="cap1"><img src="items/cap-a.png" alt="Cap A"></button>
          <button class="thumb" data-mask="cap2"><img src="items/cap-b.png" alt="Cap B"></button>
          <button class="thumb" data-mask="bucket"><img src="items/bucket-hat.png" alt="Bucket Hat"></button>
        </div>

        <div class="row">
          <div><label>Scale</label><input id="scale" type="range" min="0.2" max="3" value="1" step="0.01"></div>
          <div><label>Rotate (°)</label><input id="rotate" type="range" min="-180" max="180" value="0" step="1"></div>
        </div>
        <div class="row">
          <div><label>Opacity</label><input id="opacity" type="range" min="0" max="1" value="1" step="0.01"></div>
          <div><label>Export Size</label>
            <select id="exportSize">
              <option value="orig">Original</option>
              <option value="512">512 × 512</option>
              <option value="1024">1024 × 1024</option>
            </select>
          </div>
        </div>

        <div class="bar">
          <button id="download" class="btn">⬇ Download PNG</button>
          <button id="reset" class="btn">↻ Reset</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    const photoInput = document.getElementById('photo');
    const pickPhotoBtn = document.getElementById('pickPhoto');
    const thumbs = document.getElementById('thumbs');
    const scaleInput = document.getElementById('scale');
    const rotateInput = document.getElementById('rotate');
    const opacityInput = document.getElementById('opacity');
    const exportSizeSel = document.getElementById('exportSize');
    const resetBtn = document.getElementById('reset');
    const dlBtn = document.getElementById('download');

    const state = { bgImg:null, capImg:null, cap:{x:0,y:0,w:0,h:0,scale:1,rot:0,alpha:1} };
    const itemPaths = { cap1:'items/cap-a.png', cap2:'items/cap-b.png', bucket:'items/bucket-hat.png' };
    const presets = {};
    for (const [k,src] of Object.entries(itemPaths)){ const i=new Image(); i.src=src; presets[k]=i; }

    function loadImageFromFile(file){
      return new Promise((resolve,reject)=>{
        const r=new FileReader();
        r.onload=()=>{const img=new Image();img.onload=()=>resolve(img);img.onerror=()=>reject();img.src=r.result};
        r.readAsDataURL(file);
      });
    }

    function render(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(state.bgImg) ctx.drawImage(state.bgImg,0,0,canvas.width,canvas.height);
      if(state.capImg){
        const {x,y,w,h,scale,rot,alpha}=state.cap;
        const cw=w*scale,ch=h*scale,cx=x+cw/2,cy=y+ch/2;
        ctx.save();ctx.translate(cx,cy);ctx.rotate(rot*Math.PI/180);ctx.globalAlpha=alpha;
        ctx.drawImage(state.capImg,-cw/2,-ch/2,cw,ch);ctx.restore();ctx.globalAlpha=1;
      }
    }

    pickPhotoBtn.onclick=()=>photoInput.click();
    photoInput.onchange=async()=>{const f=photoInput.files?.[0];if(!f)return;state.bgImg=await loadImageFromFile(f);render();};
    thumbs.onclick=e=>{const box=e.target.closest('.thumb');if(!box)return;state.capImg=presets[box.dataset.mask];state.cap.x=100;state.cap.y=100;render();document.querySelectorAll('.thumb').forEach(t=>t.classList.remove('active'));box.classList.add('active');};
    scaleInput.oninput=()=>{state.cap.scale=parseFloat(scaleInput.value);render();};
    rotateInput.oninput=()=>{state.cap.rot=parseFloat(rotateInput.value);render();};
    opacityInput.oninput=()=>{state.cap.alpha=parseFloat(opacityInput.value);render();};
    resetBtn.onclick=()=>{state.bgImg=null;state.capImg=null;state.cap={x:0,y:0,w:0,h:0,scale:1,rot:0,alpha:1};render();};

    // === ОНОВЛЕНИЙ DOWNLOAD ===
    function exportPNGAndOpenReady(size){
      const off=document.createElement('canvas');
      const g=off.getContext('2d');
      if(size==='orig'){ off.width=canvas.width; off.height=canvas.height; }
      else { const s=parseInt(size,10); off.width=s; off.height=s; }
      if(state.bgImg) g.drawImage(state.bgImg,0,0,off.width,off.height);
      else { g.fillStyle='#0f0f0e'; g.fillRect(0,0,off.width,off.height); }
      if(state.capImg){
        const k=Math.min(off.width/canvas.width, off.height/canvas.height);
        const {x,y,w,h,scale,rot,alpha}=state.cap;
        const cw=w*scale*k,ch=h*scale*k;
        const cx=(x*k)+cw/2,cy=(y*k)+ch/2;
        g.save();g.translate(cx,cy);g.rotate(rot*Math.PI/180);g.globalAlpha=alpha;
        g.drawImage(state.capImg,-cw/2,-ch/2,cw,ch);g.restore();g.globalAlpha=1;
      }
      const dataURL=off.toDataURL('image/png');
      const a=document.createElement('a');a.download='pfp.png';a.href=dataURL;a.click();
      try{sessionStorage.setItem('bulk_pfp',dataURL);}catch(e){console.warn('sessionStorage full',e);}
      setTimeout(()=>{window.location.href='ready.html';},200);
    }

    dlBtn.onclick=()=>{const size=exportSizeSel.value;exportPNGAndOpenReady(size);};
  </script>
</body>
</html>
