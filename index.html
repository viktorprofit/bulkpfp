<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bulk PFP Customizer</title>
  <style>
    :root{
      --bulk-base:#141310;
      --bg-primary:#1B1A14;
      --bg-secondary:#544A4C;
      --text-primary:#FFFBEF;
      --text-secondary:#C6B6BA;
      --accent:#FFB547;
      --line:rgba(255,255,255,.06);
      --glow:rgba(255,181,71,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text-primary);
      background:linear-gradient(180deg,var(--bulk-base),var(--bg-primary));
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px;display:grid;gap:20px;grid-template-columns:1fr}
    @media(min-width:1100px){.wrap{grid-template-columns:1.2fr .9fr}}
    .stage{
      position:relative;
      background:#0f0f0e;
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      box-shadow:0 30px 80px rgba(0,0,0,.55);
      display:flex;align-items:center;justify-content:center;
    }
    canvas{
      width:86%;
      border:1px dashed rgba(255,255,255,.08);
      border-radius:12px;
      display:block;
      cursor:grab;
      touch-action:none;
    }
    .panel{
      background:#1b1a14;
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow:0 8px 22px rgba(0,0,0,.35);
    }
    .title{font-weight:700;font-size:18px;color:var(--text-primary)}
    .btn{
      appearance:none;width:100%;display:inline-flex;align-items:center;justify-content:center;gap:10px;
      background:#2a2627;color:var(--text-primary);
      border:1px solid var(--line);border-radius:12px;
      padding:14px 16px;cursor:pointer;font-weight:700;
      transition:transform .08s ease,box-shadow .25s ease,background .25s ease,filter .25s ease;
    }
    .btn.primary{
      background:linear-gradient(90deg,#FFB547,#FFBD63);
      color:#1B1A14;border:0;
      box-shadow:0 6px 20px var(--glow);
    }
    .thumbs{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .thumb{
      background:#1f1e1a;border:1px solid var(--line);border-radius:12px;
      min-height:78px;display:flex;align-items:center;justify-content:center;
      cursor:pointer;transition:border-color .25s,box-shadow .25s,background .25s;
    }
    .thumb img{max-width:88%;object-fit:contain}
    .thumb:hover{border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,181,71,.25) inset,0 0 16px var(--glow)}
    .thumb.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,181,71,.38) inset,0 0 22px var(--glow)}
  </style>
</head>
<body>
  <main class="wrap">
    <section class="stage">
      <canvas id="c" width="900" height="900"></canvas>
    </section>

    <section>
      <div class="panel">
        <div class="title">Upload PFP</div>
        <input id="photo" type="file" accept="image/png,image/jpeg,image/webp" style="display:none"/>
        <button id="pickPhoto" class="btn primary">⬆ Select Image</button>
      </div>

      <div class="panel">
        <div class="title">Select Item</div>
        <div class="thumbs" id="thumbs">
          <button class="thumb" data-mask="cap1"><img src="items/cap-a.png" alt="Cap A"></button>
          <button class="thumb" data-mask="cap2"><img src="items/cap-b.png" alt="Cap B"></button>
          <button class="thumb" data-mask="bucket"><img src="items/bucket-hat.png" alt="Bucket Hat"></button>
        </div>
        <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <button id="download" class="btn primary">⬇ Download PNG</button>
          <button id="reset" class="btn">↻ Reset</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    const canvas=document.getElementById('c'),ctx=canvas.getContext('2d');
    const photoInput=document.getElementById('photo'),pickPhotoBtn=document.getElementById('pickPhoto');
    const thumbs=document.getElementById('thumbs'),resetBtn=document.getElementById('reset'),dlBtn=document.getElementById('download');

    const state={bgImg:null,capImg:null,cap:{x:0,y:0,w:0,h:0,scale:1,rot:0,alpha:1}};
    const itemPaths={cap1:'items/cap-a.png',cap2:'items/cap-b.png',bucket:'items/bucket-hat.png'};
    const presets={};
    Object.entries(itemPaths).forEach(([k,src])=>{const i=new Image();i.src=src;presets[k]=i;});

    function loadImageFromFile(f){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>{const i=new Image();i.onload=()=>res(i);i.onerror=rej;i.src=r.result};r.onerror=rej;r.readAsDataURL(f);});}
    function fitCanvasToImage(i){const MAX=1400;let w=i.naturalWidth,h=i.naturalHeight;const k=Math.min(1,MAX/Math.max(w,h));canvas.width=w*k;canvas.height=h*k;}
    function centerCap(i){const iw=i.width||i.naturalWidth,ih=i.height||i.naturalHeight;state.cap.w=iw;state.cap.h=ih;state.cap.scale=Math.min(1,canvas.width/iw*0.5);state.cap.x=canvas.width/2-(iw*state.cap.scale)/2;state.cap.y=canvas.height*0.2;}
    function render(){ctx.clearRect(0,0,canvas.width,canvas.height);if(state.bgImg)ctx.drawImage(state.bgImg,0,0,canvas.width,canvas.height);else{ctx.fillStyle='#0f0f0e';ctx.fillRect(0,0,canvas.width,canvas.height);}if(state.capImg){const {x,y,w,h,scale,rot,alpha}=state.cap;const cw=w*scale,ch=h*scale,cx=x+cw/2,cy=y+ch/2;ctx.save();ctx.translate(cx,cy);ctx.rotate(rot*Math.PI/180);ctx.globalAlpha=alpha;ctx.drawImage(state.capImg,-cw/2,-ch/2,cw,ch);ctx.restore();ctx.globalAlpha=1;}}
    pickPhotoBtn.addEventListener('click',()=>photoInput.click());
    photoInput.addEventListener('change',async()=>{const f=photoInput.files?.[0];if(!f)return;const img=await loadImageFromFile(f);state.bgImg=img;fitCanvasToImage(img);render();});
    thumbs.addEventListener('click',e=>{const box=e.target.closest('.thumb');if(!box)return;const key=box.dataset.mask;if(!key)return;state.capImg=presets[key];centerCap(state.capImg);document.querySelectorAll('.thumb').forEach(t=>t.classList.remove('active'));box.classList.add('active');render();});
    resetBtn.addEventListener('click',()=>{state.capImg=null;document.querySelectorAll('.thumb').forEach(t=>t.classList.remove('active'));render();});
    dlBtn.addEventListener('click',()=>{const a=document.createElement('a');a.download='pfp.png';a.href=canvas.toDataURL('image/png');a.click();});

    // ===== DRAG =====
    function canvasPoint(e){const r=canvas.getBoundingClientRect();const clientX=(e.touches?.[0]?.clientX??e.clientX);const clientY=(e.touches?.[0]?.clientY??e.clientY);return{x:(clientX-r.left)*(canvas.width/r.width),y:(clientY-r.top)*(canvas.height/r.height)};}
    function hitCap(mx,my){if(!state.capImg)return false;const {x,y,w,h,scale,rot}=state.cap;const cw=w*scale,ch=h*scale,cx=x+cw/2,cy=y+ch/2;const dx=mx-cx,dy=my-cy;const ang=-rot*Math.PI/180;const rx=dx*Math.cos(ang)-dy*Math.sin(ang),ry=dx*Math.sin(ang)+dy*Math.cos(ang);return(rx>=-cw/2&&rx<=cw/2&&ry>=-ch/2&&ry<=ch/2);}
    let dragging=false,dragOff={x:0,y:0};
    function onDown(e){if(!state.capImg)return;const {x,y}=canvasPoint(e);if(hitCap(x,y)){dragging=true;dragOff.x=x-state.cap.x;dragOff.y=y-state.cap.y;canvas.style.cursor='grabbing';e.preventDefault();}}
    function onMove(e){if(!dragging){const p=canvasPoint(e);canvas.style.cursor=hitCap(p.x,p.y)?'grab':'default';return;}const {x,y}=canvasPoint(e);state.cap.x=x-dragOff.x;state.cap.y=y-dragOff.y;render();}
    function onUp(){dragging=false;canvas.style.cursor='default';}
    canvas.addEventListener('mousedown',onDown);window.addEventListener('mousemove',onMove);window.addEventListener('mouseup',onUp);
    canvas.addEventListener('touchstart',onDown,{passive:false});window.addEventListener('touchmove',onMove,{passive:false});window.addEventListener('touchend',onUp);

    // Keyboard control
    window.addEventListener('keydown',e=>{
      if(!state.capImg)return;
      const step=e.shiftKey?10:2;
      if(e.key==='ArrowLeft')state.cap.x-=step;
      else if(e.key==='ArrowRight')state.cap.x+=step;
      else if(e.key==='ArrowUp')state.cap.y-=step;
      else if(e.key==='ArrowDown')state.cap.y+=step;
      else if(e.key===']')state.cap.rot+=1;
      else if(e.key==='[')state.cap.rot-=1;
      else if(e.key==='+')state.cap.scale=Math.min(3,state.cap.scale+0.02);
      else if(e.key==='-')state.cap.scale=Math.max(0.2,state.cap.scale-0.02);
      else return;
      render();e.preventDefault();
    });

    render();
  </script>
</body>
</html>
